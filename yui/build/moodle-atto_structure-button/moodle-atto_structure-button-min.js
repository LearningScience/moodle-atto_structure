YUI.add("moodle-atto_structure-button",function(e,t){var n="atto_structure",r="structure_width",i="structure_height",s="atto_structure",o={INPUTSUBMIT:"atto_media_urlentrysubmit",INPUTCANCEL:"atto_media_urlentrycancel",WIDTHCONTROL:"widthcontrol",HEIGHTCONTROL:"heightcontrol"},u={WIDTHCONTROL:".widthcontrol",HEIGHTCONTROL:".heightcontrol"},a='<form class="atto_form"><div id="{{elementid}}_{{innerform}}" class="mdl-align"><strong>{{get_string "instructions" component}}</strong><table><tr><td><label for="{{elementid}}_{{WIDTHCONTROL}}">{{get_string "width" component}}</label></td><td><input class="{{CSS.WIDTHCONTROL}}" size="6" id="{{elementid}}_{{WIDTHCONTROL}}" name="{{elementid}}_{{WIDTHCONTROL}}" value="{{defaultwidth}}" /></td><td></td></tr><tr><td><label for="{{elementid}}_{{HEIGHTCONTROL}}">{{get_string "height" component}}</label></td><td><input class="{{CSS.HEIGHTCONTROL}}" size="6" id="{{elementid}}_{{HEIGHTCONTROL}}" name="{{elementid}}_{{HEIGHTCONTROL}}" value="{{defaultheight}}" /><td><button class="{{CSS.INPUTSUBMIT}}">{{get_string "insert" component}}</button></td></tr></table></div>icon: {{clickedicon}}</form>';e.namespace("M.atto_structure").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_usercontextid:null,_filename:null,initializer:function(e){this._usercontextid=e.usercontextid;var t=(new Date).getTime();this._filename=t;var n=this.get("host"),r=n.get("filepickeroptions");if(!r.image||!r.image.itemid)return;this._itemid=r.image.itemid;if(this.get("disabled"))return;this.addButton({icon:"icon",iconComponent:"atto_structure",buttonName:"icon",callback:this._displayDialogue,callbackArgs:"icon"})},_displayDialogue:function(t,r){t.preventDefault();var i=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:"768px",focusAfterHide:r}),s=e.Node.create("<iframe></iframe>");s.setStyles({height:"510px",border:"none",width:"100%"}),s.setAttribute("src",this._getIframeURL()),s.setAttribute("id","sketch"),s.setAttribute("data-toolbars","education");var o=this._getFormContent(r),u=e.Node.create("<div></div>");u.append(o).append(s),i.set("bodyContent",u),i.show(),this.markUpdated()},_getFormContent:function(t){var s=e.Handlebars.compile(a),u=e.Node.create(s({elementid:this.get("host").get("elementid"),CSS:o,WIDTHCONTROL:r,HEIGHTCONTROL:i,component:n,defaultwidth:this.get("defaultwidth"),defaultheight:this.get("defaultheight"),clickedicon:t}));return this._form=u,this._form.one("."+o.INPUTSUBMIT).on("click",this._getImgURL,this),u},_getIframeURL:function(){return this.get("path")+"/editor.html"},_uploadFile:function(e,t){var n=new XMLHttpRequest,r="png";n.onreadystatechange=function(e){return function(e){if(n.readyState==4&&n.status==200){var t=n.responseText,r=t.indexOf("success<error>");if(r<1)return;var i=t.indexOf("</error>"),s=t.substring(r+14,i)}}}(this);var i="datatype=uploadfile";i+="&paramone="+encodeURIComponent(e),i+="&paramtwo="+r,i+="&paramthree=image",i+="&requestid="+this._filename,i+="&contextid="+this._usercontextid,i+="&component=user",i+="&filearea=draft",i+="&itemid="+this._itemid,n.open("POST",M.cfg.wwwroot+"/lib/editor/atto/plugins/structure/structurefilelib.php",!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.setRequestHeader("Cache-Control","no-cache"),n.setRequestHeader("Content-length",i.length),n.setRequestHeader("Connection","close"),n.send(i)},_getImgURL:function(t){t.preventDefault();var n=this.getDialogue({focusAfterHide:null}).hide(),r=this._form.one(u.WIDTHCONTROL),i="";r.get("value")?i=r.get("value"):i=this.get("defaultwidth");var s=this._form.one(u.HEIGHTCONTROL),o="";s.get("value")?o=s.get("value"):o=this.get("defaultheight");var a=this;e.Get.js([this.get("path")+"/gui/gui.nocache.js",this.get("path")+"/js/marvinjslauncher.js",this.get("path")+"/js/promise-0.1.1.min.js"],function(e){if(e)return;var t;MarvinJSUtil.getEditor("#sketch").then(function(e){t=new n(e),exportPromise=t.sketcherInstance.exportStructure("mrv",null),exportPromise.then(function(e){var t={carbonLabelVisible:!1,chiralFlagVisible:!0,valenceErrorVisible:!0,lonePairsVisible:!0,implicitHydrogen:"TERMINAL_AND_HETERO",width:i,height:o};imgURL=marvin.ImageExporter.mrvToDataUrl(e,"image/png",t),a._uploadFile(imgURL,"1");var n="upfile_"+a._filename+".png",r=M.cfg.wwwroot,s=r+"/draftfile.php/"+a._usercontextid+"/user/draft/"+a._itemid+"/"+n;divContent='<div class="marvinjs-image"><img name="pict" src="'+s+'" alt="MarvinJS PNG"/></div>',a.editor.focus,a.get("host").insertContentAtFocusPoint(divContent),a.markUpdated()})});var n=function(){function e(e){this.sketcherInstance=e,this.init()}return e.prototype.init=function(){this.sketcherInstance.setDisplaySettings({cpkColoring:!0,lonePairsVisible:!0,toolbars:"education"})},e}()})}},{ATTRS:{disabled:{value:!1},usercontextid:{value:null},defaultwidth:{value:"600"},defaultheight:{value:"100"},path:{value:""}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
